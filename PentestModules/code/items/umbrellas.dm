/*
 * # Umbrellas!
 * This file has code for umbrellas!
 * Umbrellas you can hold, and open and close.
 * Currently not coding for protecting against rain as ???I dont think??? rain exists.
 * The rest don't and it just for looks.
 */
/obj/item/melee/transforming/umbrella
	name = "umbrella"
	desc = "A plain umbrella."

	icon = 'pentestModules/icons/obj/weapons/umbrellas.dmi'
	icon_state = "umbrella"
	icon_state_on = "umbrella_on"
	lefthand_file = 'pentestModules/icons/mob/inhands/weapons/umbrellas_inhand_lh.dmi'
	righthand_file = 'pentestModules/icons/mob/inhands/weapons/umbrellas_inhand_rh.dmi'

	force = 5
	throwforce = 5
	w_class = WEIGHT_CLASS_SMALL
	attack_verb = list("bludgeon", "whack", "discipline", "pummel")
	attack_verb_on = list("swooshes", "whacks", "fwumps")
	attack_verb_off = list("bludgeon", "whack", "discipline", "pummel")

	hitsound = 'sound/weapons/genhit1.ogg'
	sharpness = IS_BLUNT
	w_class_on = WEIGHT_CLASS_BULKY
	clumsy_check = FALSE
	throwforce_on = 3

	//open umbrella offsets for the inhands
	var/open_x_offset = 2
	var/open_y_offset = 2

	//Whether it's open or not
	var/open = FALSE

	/// The sound effect played when our umbrella is opened
	var/on_sound = 'sound/weapons/batonextend.ogg'
	/// The inhand icon state used when our umbrella is opened.
	var/on_inhand_icon_state = "umbrella_on"

/obj/item/melee/transforming/umbrella/worn_overlays(mutable_appearance/standing, isinhands)
	. = ..()
	if(!isinhands)
		return
	var/mob/holder = loc
	if(open)
		if(ISODD(holder.get_held_index_of_item(src))) //left hand or right hand?
			. += mutable_appearance(lefthand_file, icon_state + "_BACK", BELOW_MOB_LAYER)
		else
			. += mutable_appearance(righthand_file, icon_state + "_BACK", BELOW_MOB_LAYER)

/obj/item/melee/transforming/umbrella/transform_messages(mob/living/user, supress_message_text)
	playsound(user, on_sound, 35, TRUE)
	if(!supress_message_text)
		balloon_alert(user, active ? "opened" : "closed")
	open = active
	icon_state = active ? icon_state_on : icon_state

/obj/item/melee/transforming/umbrella/proc/get_worn_offsets(isinhands)
	. = list(0,0)
	var/mob/holder = loc
	if(isinhands)
		//Handle held offsets
		if(istype(holder))
			var/list/offsets = holder.get_item_offsets_for_index(holder.get_held_index_of_item(src))
			if(offsets)
				.[1] = offsets["x"]
				.[2] = offsets["y"]
	else
		.[2] = worn_y_offset
	if(!isinhands)
		return
	if(open)
		.[2] += open_y_offset
		switch(loc.dir)
			if(NORTH)
				.[1] += ISODD(holder.get_held_index_of_item(src)) ? -open_x_offset : open_x_offset
			if(SOUTH)
				.[1] += ISODD(holder.get_held_index_of_item(src)) ? open_x_offset : -open_x_offset
			if(EAST)
				.[1] -= open_x_offset
			if(WEST)
				.[1] += open_x_offset

//other umbrellas
/obj/item/melee/transforming/umbrella/parasol
	name = "parasol"
	desc = "A black laced parsol, how intricate."
	icon_state = "parasol"
	on_inhand_icon_state = "parasol_on"
	icon_state_on = "parasol_on"
